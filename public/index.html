<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KENVILA</title>
</head>

<body>
  <h1>KENVILA</h1>

  <form id="myForm">
    <label for="workerFirstName">Enter First Name:</label>
    <input type="text" id="workerFirstName" name="workerFirstName" required>
    <label for="workerLastName">Enter Last Name:</label>
    <input type="text" id="workerLastName" name="workerLastName" required>
    <label for="workerMobile">Enter Mobile Number:</label>
    <input type="tel" id="workerMobile" name="workerMobile" required>
    <button type="submit">Submit</button>
  </form>

  <ul id="dataList"></ul>

  <!-- Loading spinner -->
  <div id="loadingSpinner" style="display: none;">
    <!-- Add your loading spinner content or use a library like Font Awesome for icons -->
    Loading...
  </div>

  <script src="./cocket.io.js"></script>
  <script>
    const socket = io();
    document.getElementById('myForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      const workerFirstName = document.getElementById('workerFirstName').value;
      const workerLastName = document.getElementById('workerLastName').value;
      const workerMobile = document.getElementById('workerMobile').value;

      try {
        const response = await fetch('/api/data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ workerFirstName, workerLastName, workerMobile }),
        });

        const data = await response.json();
        console.log(data);

        // Display a notification when data is successfully saved
      if (data.success) {
        showNotification('Data Saved', 'Your data has been successfully saved.');
      }
      } catch (error) {
        console.error('Error:', error);
      }
    });

    const fetchData = async () => {
      try {
        const response = await fetch('/api/data');
        let data = await response.json();
        let dataList = document.getElementById('dataList');

        // Define the appendDataToList function in the global scope
        const appendDataToList = (data) => {
          let listItem = document.createElement('li');
          listItem.innerHTML = `${data.worker_first_name} ${data.worker_last_name} - ${data.worker_mobile_number}`;
          dataList.appendChild(listItem);
        };

        const appendDataToListFromSocket = (data) => {
          let listItem = document.createElement('li');
          listItem.innerHTML = `${data.workerFirstName} ${data.workerLastName} - ${data.workerMobile}`;
          dataList.appendChild(listItem);
        };
        // Append fetched data to the list
        data.forEach(appendDataToList);

        // Listen for real-time updates
        socket.on('newData', (data) => {
          console.log('New data received:', data);
          appendDataToListFromSocket(data);
        });

         // Display a notification when new data is received
    showNotification('New Data', 'New data has been added.');

      } catch (error) {
        console.error('Error fetching data:', error);
      }
    };

    // Fetch data on page load
    fetchData();

     // Function to show browser notification
  const showNotification = (title, message) => {
    if (Notification.permission === 'granted') {
      new Notification(title, { body: message });
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          new Notification(title, { body: message });
        }
      });
    }
  };

    // Show a loading spinner during slow network conditions
    document.addEventListener('readystatechange', (event) => {
      if (event.target.readyState === 'loading') {
        // Display a loading spinner
        // Example: Show a spinner with an ID "loadingSpinner"
        document.getElementById('loadingSpinner').style.display = 'block';
      } else if (event.target.readyState === 'complete') {
        // Hide the loading spinner when the page has fully loaded
        document.getElementById('loadingSpinner').style.display = 'none';
      }
    });
  </script>
</body>

</html>